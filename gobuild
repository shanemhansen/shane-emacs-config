#!/usr/bin/env python
import subprocess
import os
import shlex
import sys

def run(cmd):
    return subprocess.check_output(shlex.split(cmd))[:-1]
filename = sys.argv[1]
if filename.endswith('.go'):
    if filename[0] != '/':
        filename = os.path.join(os.getcwd(), filename)

if 'GOPATH' in os.environ:
    base = os.path.join(os.environ['GOPATH'], 'src/')
else:
    base = os.path.join(os.environ['GOROOT'], 'src/pkg/')

relative_filename = filename.replace(base,'')
package = relative_filename.replace('/'+os.path.basename(relative_filename), '')

go = os.path.join(os.environ['GOROOT'], 'bin', 'go')
try:
    if filename.endswith('.proto'):
        filename = filename.replace(os.getcwd()+'/', '')
        subprocess.call(['protoc', '--go_out=.', filename])
    elif 'test' in filename:
        subprocess.call(['go', 'test', package])
    else:
        subprocess.call(['go', 'build', package])
except:
    pass
